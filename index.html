<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Weather ‚Ä¢ Farcaster MiniApp</title>
  <meta name="theme-color" content="#9d4df1" />
  <link rel="icon" href="data:image/svg+xml,%F0%9F%8C%A4" />
  <meta name="description" content="Get live weather, daily forecasts, adaptive greetings, and morning notifications right inside Farcaster." />
  
  <!-- Preconnect for Quick Auth performance -->
  <link rel="preconnect" href="https://auth.farcaster.xyz" />
  
  <!-- Farcaster Mini App Metadata -->
  <meta name="fc:miniapp" content='{
    "version":"1",
    "imageUrl":"https://weather-base-app.vercel.app/image.png",
    "button":{
      "title":"Weather",
      "action":{
        "type":"launch_miniapp",
        "name":"Weather",
        "url":"https://weather-base-app.vercel.app/",
        "splashImageUrl":"https://weather-base-app.vercel.app/splash.png",
        "splashBackgroundColor":"#111111"
      }
    }
  }' />
  
  <!-- Open Graph -->
  <meta property="og:title" content="Weather ‚Ä¢ Farcaster MiniApp" />
  <meta property="og:description" content="Get live weather, daily forecasts, and adaptive greetings right inside Farcaster." />
  <meta property="og:image" content="https://weather-base-app.vercel.app/image.png" />
  <meta property="og:url" content="https://weather-base-app.vercel.app/" />
  <meta name="twitter:card" content="summary_large_image" />

  <style>
    :root{
      --purple:#9d4df1;
      --glass-bg:rgba(255,255,255,0.08);
      --glass-bd:rgba(255,255,255,0.15);
      --text:#f6f6f7;
      --muted:#cfd2d9;
      --radius:12px;
      --maxw:350px;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji, Noto Color Emoji;
      color:var(--text);
      background: radial-gradient(1200px 800px at 80% -10%, rgba(255,255,255,0.08), transparent 60%) fixed;
      transition: background 400ms ease;
      display:flex; align-items:center; justify-content:center; padding:16px;
    }
    .wrap{ width:100%; max-width:var(--maxw); }
    .card{ background:var(--glass-bg); border:1px solid var(--glass-bd); backdrop-filter: blur(14px); border-radius:var(--radius); padding:16px; box-shadow:0 10px 30px rgba(0,0,0,0.25); }
    .header{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px; }
    .title{ display:flex; align-items:center; gap:8px; font-weight:700; letter-spacing:.2px; }
    .badge{ padding:2px 8px; border-radius:999px; background:#201235; color:#caa9ff; border:1px solid #3b1a72; font-size:12px; }
    .user-badge{ padding:2px 8px; border-radius:999px; background:#1a2035; color:#a9c9ff; border:1px solid #1a3b72; font-size:11px; }
    .search{ display:flex; gap:8px; margin:10px 0 12px; }
    input[type="text"]{ flex:1; border-radius:10px; border:1px solid #303040; background:#12121a; color:var(--text); padding:10px 12px; outline:none; }
    input::placeholder{ color:#8b8fa3 }
    button{ border:none; background:var(--purple); color:white; border-radius:10px; padding:10px 12px; font-weight:600; cursor:pointer; transition: filter .2s ease, transform .02s; }
    button:hover{ filter: brightness(1.1); }
    button:active{ transform: translateY(1px) }
    button:disabled{ opacity:0.5; cursor:not-allowed; }
    .ghost{ background:transparent; border:1px solid #40355e; color:#d9c9ff; }
    .small-btn{ padding:6px 10px; font-size:12px; }
    .row{ display:flex; gap:12px; align-items:stretch; }
    .col{ flex:1 }
    .hero{ display:flex; gap:12px; align-items:center; margin:10px 0 14px; }
    .temp{ font-size:40px; font-weight:800; letter-spacing:-.5px; }
    .condition{ font-size:14px; color:var(--muted); }
    .chip{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid var(--glass-bd); background:rgba(255,255,255,0.05); font-size:13px; color:#dfe2ea; }
    .grid{ display:grid; grid-template-columns: repeat(2, 1fr); gap:8px; margin-top:10px; }
    .cell{ padding:10px; border-radius:10px; border:1px solid var(--glass-bd); background:rgba(255,255,255,0.04); display:flex; align-items:center; justify-content:space-between; font-size:14px; }
    .foot{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:12px; }
    .hint{ color:#9aa1b7; font-size:12px }
    .small{ font-size:12px; color:#aab0c5 }
    .greeting{ margin:12px 0 0; padding:10px 12px; border-radius:10px; background:rgba(157,77,241,0.12); border:1px solid #3b1a72; color:#eadbff; font-size:14px; }
    .alert{ margin:12px 0 0; padding:10px 12px; border-radius:10px; background:rgba(239,68,68,0.12); border:1px solid #721a1a; color:#ffeadb; font-size:13px; display:none; }
    .forecast{ display:flex; gap:8px; overflow-x:auto; padding:6px 2px 2px; margin-top:10px; -ms-overflow-style: none; scrollbar-width: none; }
    .forecast::-webkit-scrollbar{ display:none; }
    .fcard{ min-width:72px; border:1px solid var(--glass-bd); background:rgba(255,255,255,0.04); border-radius:10px; padding:8px; text-align:center; font-size:12px; }
    .fday{ color:#cbd2e6; font-weight:600; }
    .ftemp{ font-weight:700; font-size:13px }
    .share-row{ display:flex; gap:8px; margin-top:12px; }
    .share-row button{ flex:1; }
    .settings-row{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
    .settings-row button{ flex:0 0 auto; }
    .map-container{ margin-top:12px; border-radius:10px; overflow:hidden; border:1px solid var(--glass-bd); display:none; height:200px; background:rgba(255,255,255,0.04); align-items:center; justify-content:center; color:var(--muted); font-size:13px; }
    .bg-sunny{ background: linear-gradient(160deg, #FFB347 0%, #FF8C42 60%, #6b21a8 120%) fixed; }
    .bg-cloudy{ background: linear-gradient(160deg, #87CEEB 0%, #4682B4 60%, #312e81 120%) fixed; }
    .bg-rainy{ background: linear-gradient(160deg, #1e3a8a 0%, #1e40af 60%, #111827 120%) fixed; }
    .bg-night{ background: linear-gradient(160deg, #2e1065 0%, #581c87 60%, #111827 120%) fixed; }
    @media (prefers-reduced-motion: reduce){ *{ transition:none !important; animation:none !important; } }
  </style>
</head>
<body class="bg-night">
  <div class="wrap">
    <div class="card" role="region" aria-label="Weather app">
      <div class="header">
        <div class="title" aria-live="polite">
          <span style="font-size:20px">üå§Ô∏è</span>
          <span id="app-title">Weather</span>
          <span class="badge">Farcaster</span>
          <span class="user-badge" id="user-fid" style="display:none"></span>
        </div>
        <button id="btn-myloc" class="ghost" title="Back to my location" aria-label="Back to my location">üìç</button>
      </div>

      <div class="search" role="search">
        <input id="city" type="text" inputmode="search" placeholder="Search city" aria-label="Search city" />
        <button id="btn-search" aria-label="Search weather">Search</button>
      </div>

      <div class="hero" aria-live="polite">
        <div style="font-size:38px" id="emoji">‚õÖ</div>
        <div>
          <div class="temp" id="temp">--¬∞</div>
          <div class="condition" id="cond">Loading...</div>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <div class="chip" title="Humidity"><span>üíß</span><span id="humid">--%</span></div>
        </div>
        <div class="col">
          <div class="chip" title="Wind speed"><span>üçÉ</span><span id="wind">--</span></div>
        </div>
      </div>

      <div class="grid" aria-label="Details">
        <div class="cell"><span id="label-feels">Feels like</span><span id="feels">--¬∞</span></div>
        <div class="cell"><span id="label-time">Local time</span><span id="ltime">--:--</span></div>
      </div>

      <!-- Weather Alert (feature flag) -->
      <div class="alert" id="alert" role="alert">‚ö†Ô∏è <span id="alert-text"></span></div>

      <div class="forecast" id="forecast" aria-label="Forecast"></div>

      <!-- Map View (feature flag) -->
      <div class="map-container" id="map-container">
        üó∫Ô∏è <span id="map-placeholder">Map view (OpenStreetMap integration)</span>
      </div>

      <div class="greeting" id="greeting" role="status">Fetching your greeting‚Ä¶</div>

      <!-- Share buttons -->
      <div class="share-row">
        <button id="btn-cast" title="Cast weather on Farcaster">üü£ <span id="btn-cast-text">Cast</span></button>
        <button id="btn-copy" class="ghost" title="Copy weather">üìã <span id="btn-copy-text">Copy</span></button>
      </div>

      <div class="share-row">
        <button id="btn-add-miniapp" class="ghost" title="Add to your mini apps">‚ûï <span id="btn-add-text">Add MiniApp</span></button>
      </div>

      <!-- Settings (Units & Language) -->
      <div class="settings-row">
        <button id="btn-units" class="ghost small-btn">¬∞C ‚Üí ¬∞F</button>
        <button id="btn-lang" class="ghost small-btn">EN</button>
        <button id="btn-map" class="ghost small-btn" style="display:none;">üó∫Ô∏è Map</button>
        <button id="btn-alerts" class="ghost small-btn" style="display:none;">üîî Alerts</button>
      </div>

      <div class="foot">
        <div class="hint" id="status">Detecting location‚Ä¶</div>
        <div class="small" id="refresh">Updated ‚Ä¢ ‚Äî</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';

    // =====================================================
    // FEATURE FLAGS - Toggle features on/off
    // =====================================================
    const FEATURES = {
      ALERTS: true,          // Weather alerts/warnings
      MAP_VIEW: true,        // Map overlay toggle
      EXTENDED_FORECAST: true, // 7-day forecast
      NOTIFICATIONS: true,   // Browser notifications
      UNIT_TOGGLE: true,     // Temp/speed unit switching
      LOCALIZATION: true     // Multi-language support
    };

    // =====================================================
    // LOCALIZATION MODULE
    // =====================================================
    const TRANSLATIONS = {
      en: {
        appTitle: "Weather",
        searchPlaceholder: "Search city (e.g., Bangalore)",
        feelsLike: "Feels like",
        localTime: "Local time",
        humidity: "Humidity",
        wind: "Wind",
        castBtn: "Cast",
        copyBtn: "Copy",
        addBtn: "Add MiniApp",
        searchBtn: "Search",
        loading: "Loading...",
        offline: "Offline ‚Äî showing saved weather data ‚òÅÔ∏è",
        cityNotFound: "City not found",
        detectingLocation: "Detecting location‚Ä¶",
        yourLocation: "Your location",
        goodMorning: "‚òÄÔ∏è Good morning",
        goodAfternoon: "üå§Ô∏è Good afternoon",
        goodEvening: "üåô Good evening",
        clearDay: "Bright and clear ‚Äî perfect day to ship!",
        cloudyDay: "Cloudy skies ‚Äî cozy coding weather.",
        rainyDay: "Rainy vibes ‚Äî great time to code indoors.",
        snowyDay: "Snowy mood ‚Äî warm beverage and deep focus.",
        stormyDay: "Stormy out ‚Äî perfect to build something big inside.",
        defaultDay: "Let's build something new today.",
        copied: "üìã Copied to clipboard!",
        castPosted: "‚úÖ Cast posted!",
        miniappAdded: "‚úÖ MiniApp added!",
        mapPlaceholder: "Map view (OpenStreetMap integration)"
      },
      es: {
        appTitle: "Clima",
        searchPlaceholder: "Buscar ciudad (ej., Madrid)",
        feelsLike: "Se siente como",
        localTime: "Hora local",
        humidity: "Humedad",
        wind: "Viento",
        castBtn: "Publicar",
        copyBtn: "Copiar",
        addBtn: "A√±adir App",
        searchBtn: "Buscar",
        loading: "Cargando...",
        offline: "Sin conexi√≥n ‚Äî mostrando datos guardados ‚òÅÔ∏è",
        cityNotFound: "Ciudad no encontrada",
        detectingLocation: "Detectando ubicaci√≥n‚Ä¶",
        yourLocation: "Tu ubicaci√≥n",
        goodMorning: "‚òÄÔ∏è Buenos d√≠as",
        goodAfternoon: "üå§Ô∏è Buenas tardes",
        goodEvening: "üåô Buenas noches",
        clearDay: "D√≠a despejado ‚Äî perfecto para crear!",
        cloudyDay: "Cielos nublados ‚Äî clima perfecto para programar.",
        rainyDay: "Ambiente lluvioso ‚Äî ideal para codear dentro.",
        snowyDay: "D√≠a nevado ‚Äî bebida caliente y concentraci√≥n.",
        stormyDay: "Tormenta afuera ‚Äî perfecto para construir algo grande.",
        defaultDay: "Construyamos algo nuevo hoy.",
        copied: "üìã ¬°Copiado al portapapeles!",
        castPosted: "‚úÖ ¬°Publicaci√≥n enviada!",
        miniappAdded: "‚úÖ ¬°App a√±adida!",
        mapPlaceholder: "Vista de mapa (integraci√≥n OpenStreetMap)"
      },
      hi: {
        appTitle: "‡§Æ‡•å‡§∏‡§Æ",
        searchPlaceholder: "‡§∂‡§π‡§∞ ‡§ñ‡•ã‡§ú‡•á‡§Ç (‡§ú‡•à‡§∏‡•á, ‡§¨‡•á‡§Ç‡§ó‡§≤‡•Å‡§∞‡•Å)",
        feelsLike: "‡§Æ‡§π‡§∏‡•Ç‡§∏ ‡§π‡•ã‡§§‡§æ ‡§π‡•à",
        localTime: "‡§∏‡•ç‡§•‡§æ‡§®‡•Ä‡§Ø ‡§∏‡§Æ‡§Ø",
        humidity: "‡§®‡§Æ‡•Ä",
        wind: "‡§π‡§µ‡§æ",
        castBtn: "‡§™‡•ã‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç",
        copyBtn: "‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç",
        addBtn: "‡§ê‡§™ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç",
        searchBtn: "‡§ñ‡•ã‡§ú‡•á‡§Ç",
        loading: "‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...",
        offline: "‡§ë‡§´‡§º‡§≤‡§æ‡§á‡§® ‚Äî ‡§∏‡§π‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ ‡§°‡•á‡§ü‡§æ ‡§¶‡§ø‡§ñ‡§æ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç ‚òÅÔ∏è",
        cityNotFound: "‡§∂‡§π‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ",
        detectingLocation: "‡§∏‡•ç‡§•‡§æ‡§® ‡§ï‡§æ ‡§™‡§§‡§æ ‡§≤‡§ó‡§æ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç‚Ä¶",
        yourLocation: "‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§•‡§æ‡§®",
        goodMorning: "‚òÄÔ∏è ‡§∏‡•Å‡§™‡•ç‡§∞‡§≠‡§æ‡§§",
        goodAfternoon: "üå§Ô∏è ‡§∂‡•Å‡§≠ ‡§¶‡•ã‡§™‡§π‡§∞",
        goodEvening: "üåô ‡§∂‡•Å‡§≠ ‡§∏‡§Ç‡§ß‡•ç‡§Ø‡§æ",
        clearDay: "‡§∏‡§æ‡§´‡§º ‡§î‡§∞ ‡§∏‡•ç‡§™‡§∑‡•ç‡§ü ‚Äî ‡§ï‡•Å‡§õ ‡§®‡§Ø‡§æ ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡§æ ‡§¶‡§ø‡§®!",
        cloudyDay: "‡§¨‡§æ‡§¶‡§≤ ‡§õ‡§æ‡§è ‡§π‡•à‡§Ç ‚Äî ‡§ï‡•ã‡§°‡§ø‡§Ç‡§ó ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§∞‡§æ‡§Æ‡§¶‡§æ‡§Ø‡§ï ‡§Æ‡•å‡§∏‡§Æ‡•§",
        rainyDay: "‡§¨‡§æ‡§∞‡§ø‡§∂ ‡§ï‡§æ ‡§Æ‡•å‡§∏‡§Æ ‚Äî ‡§Ö‡§Ç‡§¶‡§∞ ‡§ï‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§∏‡§Æ‡§Ø‡•§",
        snowyDay: "‡§¨‡§∞‡•ç‡§´‡•Ä‡§≤‡§æ ‡§Æ‡•å‡§∏‡§Æ ‚Äî ‡§ó‡§∞‡•ç‡§Æ ‡§™‡•á‡§Ø ‡§î‡§∞ ‡§ó‡§π‡§∞‡§æ ‡§´‡•ã‡§ï‡§∏‡•§",
        stormyDay: "‡§§‡•Ç‡§´‡§º‡§æ‡§® ‡§¨‡§æ‡§π‡§∞ ‡§π‡•à ‚Äî ‡§Ö‡§Ç‡§¶‡§∞ ‡§ï‡•Å‡§õ ‡§¨‡§°‡§º‡§æ ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡§æ ‡§∏‡§Æ‡§Ø‡•§",
        defaultDay: "‡§Ü‡§ú ‡§ï‡•Å‡§õ ‡§®‡§Ø‡§æ ‡§¨‡§®‡§æ‡§è‡§Ç‡•§",
        copied: "üìã ‡§ï‡•ç‡§≤‡§ø‡§™‡§¨‡•ã‡§∞‡•ç‡§° ‡§™‡§∞ ‡§ï‡•â‡§™‡•Ä ‡§ï‡§ø‡§Ø‡§æ!",
        castPosted: "‚úÖ ‡§™‡•ã‡§∏‡•ç‡§ü ‡§≠‡•á‡§ú‡•Ä ‡§ó‡§à!",
        miniappAdded: "‚úÖ ‡§ê‡§™ ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ!",
        mapPlaceholder: "‡§Æ‡•à‡§™ ‡§µ‡•ç‡§Ø‡•Ç (OpenStreetMap ‡§á‡§Ç‡§ü‡•Ä‡§ó‡•ç‡§∞‡•á‡§∂‡§®)"
      }
    };

    // =====================================================
    // UNIT CONVERSION MODULE
    // =====================================================
    const UNITS = {
      temperature: {
        celsius: { symbol: "¬∞C", convert: (c) => c },
        fahrenheit: { symbol: "¬∞F", convert: (c) => (c * 9/5) + 32 }
      },
      speed: {
        kmh: { symbol: "km/h", convert: (kmh) => kmh },
        mph: { symbol: "mph", convert: (kmh) => kmh * 0.621371 }
      }
    };

    // =====================================================
    // STATE & CONFIG
    // =====================================================
    const STATE = {
      currentLang: load("language", "en"),
      currentTempUnit: load("tempUnit", "celsius"),
      currentSpeedUnit: load("speedUnit", "kmh"),
      mapVisible: false,
      alertsEnabled: FEATURES.ALERTS
    };

    const OPEN_METEO = "https://api.open-meteo.com/v1/forecast";
    const GEO_CODE   = "https://geocoding-api.open-meteo.com/v1/search";
    const DEFAULT_CITY = { name:"Bangalore", latitude:12.9716, longitude:77.5946 };

    // WMO codes
    const WMO = {
      0:{t:"Clear sky",e:"‚òÄÔ∏è",bg:"sunny",alert:false}, 1:{t:"Mainly clear",e:"üå§Ô∏è",bg:"sunny",alert:false}, 
      2:{t:"Partly cloudy",e:"‚õÖ",bg:"cloudy",alert:false}, 3:{t:"Overcast",e:"‚òÅÔ∏è",bg:"cloudy",alert:false},
      45:{t:"Fog",e:"üå´Ô∏è",bg:"cloudy",alert:false}, 48:{t:"Depositing rime fog",e:"üå´Ô∏è",bg:"cloudy",alert:false},
      51:{t:"Light drizzle",e:"üå¶Ô∏è",bg:"rainy",alert:false}, 53:{t:"Moderate drizzle",e:"üå¶Ô∏è",bg:"rainy",alert:false}, 
      55:{t:"Dense drizzle",e:"üåßÔ∏è",bg:"rainy",alert:false}, 56:{t:"Freezing drizzle: light",e:"üåßÔ∏è",bg:"rainy",alert:true},
      57:{t:"Freezing drizzle: dense",e:"üåßÔ∏è",bg:"rainy",alert:true}, 61:{t:"Slight rain",e:"üåßÔ∏è",bg:"rainy",alert:false},
      63:{t:"Moderate rain",e:"üåßÔ∏è",bg:"rainy",alert:false}, 65:{t:"Heavy rain",e:"üåßÔ∏è",bg:"rainy",alert:true},
      66:{t:"Freezing rain: light",e:"üåßÔ∏è",bg:"rainy",alert:true}, 67:{t:"Freezing rain: heavy",e:"üåßÔ∏è",bg:"rainy",alert:true},
      71:{t:"Slight snow",e:"üå®Ô∏è",bg:"cloudy",alert:false}, 73:{t:"Moderate snow",e:"‚ùÑÔ∏è",bg:"cloudy",alert:false},
      75:{t:"Heavy snow",e:"‚ùÑÔ∏è",bg:"cloudy",alert:true}, 77:{t:"Snow grains",e:"üå®Ô∏è",bg:"cloudy",alert:false},
      80:{t:"Rain showers: slight",e:"üåßÔ∏è",bg:"rainy",alert:false}, 81:{t:"Rain showers: moderate",e:"üåßÔ∏è",bg:"rainy",alert:false},
      82:{t:"Rain showers: violent",e:"üåßÔ∏è",bg:"rainy",alert:true}, 85:{t:"Snow showers: slight",e:"üå®Ô∏è",bg:"cloudy",alert:false},
      86:{t:"Snow showers: heavy",e:"‚ùÑÔ∏è",bg:"cloudy",alert:true}, 95:{t:"Thunderstorm",e:"‚õàÔ∏è",bg:"rainy",alert:true},
      96:{t:"Thunderstorm with slight hail",e:"‚õàÔ∏è",bg:"rainy",alert:true}, 99:{t:"Thunderstorm with heavy hail",e:"‚õàÔ∏è",bg:"rainy",alert:true}
    };

    // DOM
    const els = {
      appTitle: document.getElementById("app-title"),
      emoji: document.getElementById("emoji"),
      temp: document.getElementById("temp"),
      cond: document.getElementById("cond"),
      humid: document.getElementById("humid"),
      wind: document.getElementById("wind"),
      feels: document.getElementById("feels"),
      ltime: document.getElementById("ltime"),
      greeting: document.getElementById("greeting"),
      alert: document.getElementById("alert"),
      alertText: document.getElementById("alert-text"),
      status: document.getElementById("status"),
      refresh: document.getElementById("refresh"),
      forecast: document.getElementById("forecast"),
      city: document.getElementById("city"),
      btnSearch: document.getElementById("btn-search"),
      btnMyLoc: document.getElementById("btn-myloc"),
      btnCast: document.getElementById("btn-cast"),
      btnCopy: document.getElementById("btn-copy"),
      btnAddMiniapp: document.getElementById("btn-add-miniapp"),
      btnUnits: document.getElementById("btn-units"),
      btnLang: document.getElementById("btn-lang"),
      btnMap: document.getElementById("btn-map"),
      btnAlerts: document.getElementById("btn-alerts"),
      userFid: document.getElementById("user-fid"),
      labelFeels: document.getElementById("label-feels"),
      labelTime: document.getElementById("label-time"),
      btnCastText: document.getElementById("btn-cast-text"),
      btnCopyText: document.getElementById("btn-copy-text"),
      btnAddText: document.getElementById("btn-add-text"),
      mapContainer: document.getElementById("map-container"),
      mapPlaceholder: document.getElementById("map-placeholder")
    };

    // Storage helpers
    const save = (k,v) => localStorage.setItem(k, JSON.stringify(v));
    const load = (k,d=null) => { try { return JSON.parse(localStorage.getItem(k)) ?? d; } catch { return d; } };

    // =====================================================
    // LOCALIZATION FUNCTIONS
    // =====================================================
    function t(key) {
      return TRANSLATIONS[STATE.currentLang]?.[key] || TRANSLATIONS.en[key] || key;
    }

    function updateUILanguage() {
      els.appTitle.textContent = t("appTitle");
      els.city.placeholder = t("searchPlaceholder");
      els.labelFeels.textContent = t("feelsLike");
      els.labelTime.textContent = t("localTime");
      els.btnCastText.textContent = t("castBtn");
      els.btnCopyText.textContent = t("copyBtn");
      els.btnAddText.textContent = t("addBtn");
      els.mapPlaceholder.textContent = t("mapPlaceholder");
      
      const langs = ['en', 'es', 'hi'];
      const currentIdx = langs.indexOf(STATE.currentLang);
      const nextLang = langs[(currentIdx + 1) % langs.length];
      els.btnLang.textContent = nextLang.toUpperCase();
    }

    // =====================================================
    // UNIT CONVERSION FUNCTIONS
    // =====================================================
    function convertTemp(celsius) {
      return Math.round(UNITS.temperature[STATE.currentTempUnit].convert(celsius));
    }

    function convertSpeed(kmh) {
      return Math.round(UNITS.speed[STATE.currentSpeedUnit].convert(kmh));
    }

    function getTempSymbol() {
      return UNITS.temperature[STATE.currentTempUnit].symbol;
    }

    function getSpeedSymbol() {
      return UNITS.speed[STATE.currentSpeedUnit].symbol;
    }

    function toggleUnits() {
      if (STATE.currentTempUnit === "celsius") {
        STATE.currentTempUnit = "fahrenheit";
        STATE.currentSpeedUnit = "mph";
        els.btnUnits.textContent = "¬∞F ‚Üí ¬∞C";
      } else {
        STATE.currentTempUnit = "celsius";
        STATE.currentSpeedUnit = "kmh";
        els.btnUnits.textContent = "¬∞C ‚Üí ¬∞F";
      }
      save("tempUnit", STATE.currentTempUnit);
      save("speedUnit", STATE.currentSpeedUnit);
      
      // Re-render current weather with new units
      const cached = load("lastWeather");
      if (cached) render(cached.data, cached.placeName);
    }

    function toggleLanguage() {
      const langs = ['en', 'es', 'hi'];
      const currentIdx = langs.indexOf(STATE.currentLang);
      STATE.currentLang = langs[(currentIdx + 1) % langs.length];
      save("language", STATE.currentLang);
      updateUILanguage();
      
      // Re-render to update greeting
      const cached = load("lastWeather");
      if (cached) render(cached.data, cached.placeName);
    }

    // =====================================================
    // UI HELPERS
    // =====================================================
    function setBackgroundByCode(code, isNight=false){
      const info = WMO[code] || WMO[2];
      document.body.className = isNight ? "bg-night" : `bg-${info.bg}`;
    }

    function formatTimeLocal(dateStr){
      try{ return new Date(dateStr).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }catch{return "--:--";}
    }

    function toast(msg){
      els.status.textContent = msg;
      setTimeout(()=> els.status.textContent = "", 2500);
    }

    function copy(txt){ 
      try{ 
        navigator.clipboard.writeText(txt);
        toast(t("copied"));
      }catch{
        toast("Copy failed");
      } 
    }

    // =====================================================
    // WEATHER ALERT MODULE (Feature Flag)
    // =====================================================
    function checkWeatherAlert(code) {
      if (!FEATURES.ALERTS || !STATE.alertsEnabled) {
        els.alert.style.display = "none";
        return;
      }

      const info = WMO[code] || WMO[2];
      if (info.alert) {
        els.alertText.textContent = `${info.t} - Stay safe and check local advisories`;
        els.alert.style.display = "block";
      } else {
        els.alert.style.display = "none";
      }
    }

    // =====================================================
    // ADAPTIVE GREETING (Localized)
    // =====================================================
    function adaptiveGreeting(code, name){
      const hr = new Date().getHours();
      const base =
        (hr >= 6 && hr < 12) ? t("goodMorning") :
        (hr >= 12 && hr < 18) ? t("goodAfternoon") :
        t("goodEvening");
      
      let tail = t("defaultDay");
      if ([0,1].includes(code)) tail = t("clearDay");
      else if ([2,3,45,48].includes(code)) tail = t("cloudyDay");
      else if ([51,53,55,56,57,61,63,65,66,67,80,81,82].includes(code)) tail = t("rainyDay");
      else if ([71,73,75,77,85,86].includes(code)) tail = t("snowyDay");
      else if ([95,96,99].includes(code)) tail = t("stormyDay");
      
      const msg = `${base}${name?`, ${name}`:""}! ${tail}`;
      els.greeting.textContent = msg;
      save("greetMsg", msg);
    }

    // =====================================================
    // TIME TRACKING
    // =====================================================
    let lastUpdatedTs = null;
    function setUpdatedNow(){
      lastUpdatedTs = Date.now();
      els.refresh.textContent = `Updated ‚Ä¢ ${new Date(lastUpdatedTs).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
    }
    setInterval(()=>{
      if (!lastUpdatedTs) return;
      const mins = Math.floor((Date.now() - lastUpdatedTs)/60000);
      if (mins <= 0) return;
      els.refresh.textContent = `Updated ‚Ä¢ ${mins}m ago`;
    }, 60000);

    // =====================================================
    // WEATHER FETCH
    // =====================================================
    async function fetchWeather(lat, lon){
      const days = FEATURES.EXTENDED_FORECAST ? 7 : 5;
      const url = `${OPEN_METEO}?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,wind_speed_10m,weather_code,is_day&hourly=weather_code,temperature_2m&daily=weather_code,temperature_2m_max,temperature_2m_min&forecast_days=${days}&timezone=auto`;
      const res = await fetch(url, { cache:"no-store" });
      if (!res.ok) throw new Error("Weather fetch failed");
      return res.json();
    }

    async function geocodeCity(q){
      const url = `${GEO_CODE}?name=${encodeURIComponent(q)}&count=1&language=en&format=json`;
      const res = await fetch(url, { cache:"no-store" });
      if (!res.ok) throw new Error("City lookup failed");
      const data = await res.json();
      if (!data.results || !data.results.length) throw new Error(t("cityNotFound"));
      const r = data.results[0];
      return { name: r.name, latitude: r.latitude, longitude: r.longitude, country:r.country };
    }

    // =====================================================
    // RENDER WITH UNITS & LOCALIZATION
    // =====================================================
    function render(data, placeName = "Your location"){
      try{
        const cur = data.current;
        const daily = data.daily;
        const code = cur.weather_code;
        const info = WMO[code] || {t:"Unknown", e:"‚õÖ", bg:"cloudy", alert:false};
        const isNight = (typeof cur.is_day === "number") ? (cur.is_day === 0) : false;

        setBackgroundByCode(code, isNight);
        els.emoji.textContent = info.e;
        els.temp.textContent = `${convertTemp(cur.temperature_2m)}${getTempSymbol()}`;
        els.cond.textContent = `${info.t} ‚Ä¢ ${placeName}`;
        els.humid.textContent = `${Math.round(cur.relative_humidity_2m)}%`;
        els.wind.textContent = `${convertSpeed(cur.wind_speed_10m)} ${getSpeedSymbol()}`;
        els.feels.textContent = `${convertTemp(cur.apparent_temperature ?? cur.temperature_2m)}${getTempSymbol()}`;
        els.ltime.textContent = formatTimeLocal(cur.time);

        // Weather alert check
        checkWeatherAlert(code);

        // Temp-change alert
        const prevTemp = load("lastTemp", null);
        if (prevTemp !== null && Math.abs(prevTemp - cur.temperature_2m) > 3){
          toast(`üå°Ô∏è Temp changed ${Math.round(cur.temperature_2m - prevTemp)}¬∞C since last check`);
        }
        save("lastTemp", cur.temperature_2m);

        // Adaptive greeting
        adaptiveGreeting(code, (placeName || "").split(",")[0]);

        // Forecast
        els.forecast.innerHTML = "";
        if (daily && daily.time && daily.time.length){
          const days = daily.time;
          days.forEach((d,i)=>{
            const dcode = daily.weather_code[i];
            const max = convertTemp(daily.temperature_2m_max[i]);
            const min = convertTemp(daily.temperature_2m_min[i]);
            const label = new Date(d).toLocaleDateString([], { weekday:"short" });
            const dinfo = WMO[dcode] || {e:"‚õÖ"};
            const node = document.createElement("div");
            node.className = "fcard";
            node.innerHTML = `
              <div class="fday">${label}</div>
              <div style="font-size:18px;margin:4px 0">${dinfo.e}</div>
              <div class="ftemp">‚Üë${max}¬∞ ‚Üì${min}¬∞</div>
            `;
            els.forecast.appendChild(node);
          });
        }

        save("lastWeather", { data, placeName, ts: Date.now() });
      }catch(err){
        console.error(err);
        els.status.textContent = "Render error";
      }
    }

    async function loadByCoords(lat, lon, label="Your location"){
      els.status.textContent = t("loading");
      try{
        const data = await fetchWeather(lat, lon);
        render(data, label);
        setUpdatedNow();
        els.status.textContent = "";
      }catch(err){
        console.error(err);
        els.status.textContent = t("offline");
        const cache = load("lastWeather");
        if (cache){ render(cache.data, cache.placeName || label); }
      }
    }

    async function initGeolocation(){
      return new Promise((resolve)=>{
        if (!navigator.geolocation){
          resolve({ coords: { latitude: DEFAULT_CITY.latitude, longitude: DEFAULT_CITY.longitude }, from:"fallback" }); return;
        }
        navigator.geolocation.getCurrentPosition(
          (pos)=> resolve({ coords: pos.coords, from:"geo" }),
          ()=> resolve({ coords: { latitude: DEFAULT_CITY.latitude, longitude: DEFAULT_CITY.longitude }, from:"fallback" }),
          { enableHighAccuracy:false, timeout:8000, maximumAge:300000 }
        );
      });
    }

    // =====================================================
    // AUTO-REFRESH
    // =====================================================
    let lastGeo = null;
    let refreshTimer = null;
    function scheduleAutoRefresh(lat, lon, label){
      const threeHours = 3 * 60 * 60 * 1000;
      if (refreshTimer) clearInterval(refreshTimer);
      refreshTimer = setInterval(()=> loadByCoords(lat, lon, label), threeHours);
      document.addEventListener("visibilitychange", ()=>{
        if (!document.hidden){ loadByCoords(lat, lon, label); }
      }, { once:true });
    }

    // =====================================================
    // MORNING GREETING
    // =====================================================
    function checkMorningGreeting(){
      const lastMsgDate = load("lastGreetDate", "");
      const today = new Date().toDateString();
      if (lastMsgDate !== today) {
        const greetMsg = load("greetMsg", t("goodMorning"));
        toast(greetMsg);
        if (FEATURES.NOTIFICATIONS && "Notification" in window && Notification.permission === "granted") {
          try { new Notification("üå§Ô∏è Daily Weather", { body: greetMsg }); } catch {}
        }
        save("lastGreetDate", today);
      }
    }
    if (FEATURES.NOTIFICATIONS && "Notification" in window && Notification.permission === "default") {
      try { Notification.requestPermission().catch(()=>{}); } catch {}
    }
    setInterval(()=>{
      const hr = new Date().getHours();
      if (hr >= 6 && hr < 9) checkMorningGreeting();
    }, 60 * 60 * 1000);

    // =====================================================
    // SHARE FUNCTIONS
    // =====================================================
    function getWeatherText(){
      const emoji = els.emoji.textContent;
      const temp = els.temp.textContent;
      const cond = els.cond.textContent;
      const humid = els.humid.textContent;
      const wind = els.wind.textContent;
      return `${emoji} Weather Update\n\n${temp} ${cond}\nüíß ${humid} humidity ‚Ä¢ üçÉ ${wind} wind\n\nvia Weather MiniApp üå§Ô∏è`;
    }

    async function castWeather(){
      try {
        els.btnCast.disabled = true;
        els.btnCast.textContent = "Casting...";
        
        const result = await sdk.actions.composeCast({
          text: getWeatherText(),
          embeds: ["https://weather-base-app.vercel.app/"]
        });

        if (result?.cast) {
          toast(`${t("castPosted")} Hash: ${result.cast.hash.slice(0,10)}...`);
        } else {
          toast("Cast cancelled");
        }
      } catch(err) {
        console.error("Cast error:", err);
        toast("Cast failed - try copy instead");
      } finally {
        els.btnCast.disabled = false;
        els.btnCast.textContent = `üü£ ${t("castBtn")}`;
      }
    }

    function copyWeather(){
      copy(getWeatherText());
    }

    async function addMiniApp(){
      try {
        els.btnAddMiniapp.disabled = true;
        els.btnAddMiniapp.textContent = "Adding...";
        
        await sdk.actions.addMiniApp();
        toast(t("miniappAdded"));
      } catch(err) {
        console.error("Add MiniApp error:", err);
        toast("Add MiniApp failed");
      } finally {
        els.btnAddMiniapp.disabled = false;
        els.btnAddMiniapp.textContent = `‚ûï ${t("addBtn")}`;
      }
    }

    // =====================================================
    // MAP VIEW TOGGLE (Feature Flag)
    // =====================================================
    function toggleMapView(){
      STATE.mapVisible = !STATE.mapVisible;
      els.mapContainer.style.display = STATE.mapVisible ? "flex" : "none";
      els.btnMap.textContent = STATE.mapVisible ? "üó∫Ô∏è Hide" : "üó∫Ô∏è Map";
    }

    function toggleAlerts(){
      STATE.alertsEnabled = !STATE.alertsEnabled;
      els.btnAlerts.textContent = STATE.alertsEnabled ? "üîî On" : "üîî Off";
      const cached = load("lastWeather");
      if (cached) render(cached.data, cached.placeName);
    }

    // =====================================================
    // FARCASTER CONTEXT
    // =====================================================
    let farcasterUser = null;
    async function initFarcasterContext(){
      try {
        const context = await sdk.context;
        if (context?.user?.fid) {
          farcasterUser = context.user;
          els.userFid.textContent = `FID: ${farcasterUser.fid}`;
          els.userFid.style.display = "inline-flex";
        }
      } catch(err) {
        console.log("No Farcaster context:", err);
      }
    }

    // =====================================================
    // EVENT HANDLERS
    // =====================================================
    els.btnSearch.addEventListener("click", async ()=>{
      const q = els.city.value.trim();
      if (!q) return;
      els.status.textContent = t("loading");
      try{
        const loc = await geocodeCity(q);
        els.city.blur();
        const label = `${loc.name}, ${loc.country || ""}`.trim();
        await loadByCoords(loc.latitude, loc.longitude, label);
        scheduleAutoRefresh(loc.latitude, loc.longitude, label);
        save("lastCity", loc);
      }catch(err){
        console.error(err);
        els.status.textContent = t("cityNotFound");
      }
    });
    
    els.city.addEventListener("keydown", (e)=>{ if (e.key === "Enter") els.btnSearch.click(); });
    els.btnCast.addEventListener("click", castWeather);
    els.btnCopy.addEventListener("click", copyWeather);
    els.btnAddMiniapp.addEventListener("click", addMiniApp);
    els.btnUnits.addEventListener("click", toggleUnits);
    els.btnLang.addEventListener("click", toggleLanguage);
    
    if (FEATURES.MAP_VIEW) {
      els.btnMap.style.display = "inline-block";
      els.btnMap.addEventListener("click", toggleMapView);
    }
    
    if (FEATURES.ALERTS) {
      els.btnAlerts.style.display = "inline-block";
      els.btnAlerts.addEventListener("click", toggleAlerts);
    }
    
    els.btnMyLoc.addEventListener("click", async ()=>{
      if (lastGeo){
        const label = t("yourLocation");
        await loadByCoords(lastGeo.lat, lastGeo.lon, label);
        scheduleAutoRefresh(lastGeo.lat, lastGeo.lon, label);
      } else {
        els.status.textContent = t("detectingLocation");
        const { coords } = await initGeolocation();
        lastGeo = { lat: coords.latitude, lon: coords.longitude };
        await loadByCoords(coords.latitude, coords.longitude, t("yourLocation"));
        scheduleAutoRefresh(coords.latitude, coords.longitude, t("yourLocation"));
      }
    });

    // =====================================================
    // BOOT SEQUENCE
    // =====================================================
    (async function boot(){
      // Initialize UI language
      updateUILanguage();
      
      // Show cached data
      const cached = load("lastWeather");
      if (cached) { render(cached.data, cached.placeName); }

      // Initialize Farcaster context
      await initFarcasterContext();

      // Load weather
      const { coords, from } = await initGeolocation();
      const label = from === "geo" ? t("yourLocation") : `${DEFAULT_CITY.name}`;
      lastGeo = { lat: coords.latitude, lon: coords.longitude };
      await loadByCoords(coords.latitude, coords.longitude, label);
      scheduleAutoRefresh(coords.latitude, coords.longitude, label);

      const lastCity = load("lastCity");
      if (lastCity) els.city.placeholder = `${t("searchPlaceholder").split("(")[0]}(${lastCity.name})`;

      const hr = new Date().getHours();
      if (hr >= 6 && hr < 9) checkMorningGreeting();

      // Signal SDK ready
      try {
        await sdk.actions.ready();
        console.log("‚úÖ Farcaster SDK ready");
      } catch(err) {
        console.log("Not in Farcaster context:", err);
      }
    })();
  </script>
</body>
</html>
